var epubDB={base:null,page:null,toc:null},epubPath="./contents/ebook/OEBPS",blankPage="./blank.html",creator="HP",loadBG=!0,loadSvg=!0,imgFormat="png",preview="pd",pages=[blankPage,blankPage],epubInfo,epubToc,pageInfo,startpage=0,drawingData=[],bookmarkData=[],currentPageIdx=-1,currentOnePageIdx=0,hl_canvas,hl_context,rangeSlider,zoomSlider,alphaSlider,viewBox={mode:"both",scale:1,zoom:100,w:0,h:0,moving_step:5},viewPort={w:0,h:0,vw:0,vh:0},svgViewBox={scale:1,w:595.276,h:779.52802},bHandleOn=!1,
execTime=0,requestedPage,pageLocationTask,drawingAlphaValue,preLoadingWorker,isLoadedPageFlip=!1,isWebview=void 0!==window.lampedu||void 0!==window.viewer?!0:!1,TYPE_MODAL=1,TYPE_SLIDE=2,resultType=isWebview&&void 0!==window.lampedu?TYPE_SLIDE:TYPE_MODAL,SIDEMENU_TOC=1,SIDEMENU_THUMB=2,SIDEMENU_BOOKMARK=3,SIDEMENU_SEARCH=4,sideMenu={toc:null,thumb:null,bookmark:null,search:null,setMenu:function(a,b){switch(b){case SIDEMENU_TOC:this.toc=a;this.toc.name="CONTENTS";this.toc.type=b;break;case SIDEMENU_THUMB:this.thumb=
a;this.thumb.name="PAGE";this.thumb.type=b;this.thumb.isLoaded=!1;break;case SIDEMENU_BOOKMARK:this.bookmark=a;this.bookmark.name="BOOKMARK";this.bookmark.type=b;break;case SIDEMENU_SEARCH:this.search=a,this.search.name="SEARCH",this.search.type=b}},getMenu:function(a){switch(a){case SIDEMENU_TOC:return this.toc;case SIDEMENU_THUMB:return this.thumb;case SIDEMENU_BOOKMARK:return this.bookmark;case SIDEMENU_SEARCH:return this.search}return null},open:function(a){this.closeAllButNotThis(a);classie.add(this.getMenu(a),
"cbp-spmenu-open");void 0!==window.lampedu&&window.lampedu.setViewerLeftTopButtonChange(!0,this.getMenu(a).name);a!==SIDEMENU_THUMB||this.thumb.isLoaded||loadThumb()},toggle:function(a){classie.has(this.getMenu(a),"cbp-spmenu-open")?this.close(a):this.open(a)},close:function(a){classie.remove(this.getMenu(a),"cbp-spmenu-open");void 0!==window.lampedu&&window.lampedu.setViewerLeftTopButtonChange(!1,this.getMenu(a).name)},closeAll:function(){this.close(SIDEMENU_TOC);this.close(SIDEMENU_THUMB);this.close(SIDEMENU_BOOKMARK);
this.close(SIDEMENU_SEARCH)},closeAllButNotThis:function(a){a!==SIDEMENU_TOC&&this.close(SIDEMENU_TOC);a!==SIDEMENU_THUMB&&this.close(SIDEMENU_THUMB);a!==SIDEMENU_BOOKMARK&&this.close(SIDEMENU_BOOKMARK);a!==SIDEMENU_SEARCH&&this.close(SIDEMENU_SEARCH)}},menu=[{className:"CopyClipboard",name:"\ud074\ub9bd\ubcf4\ub4dc\uc5d0 \ubcf5\uc0ac",fun:function(){copyToClipboard(document.getElementById("copiedText"));disableHighlight()}},{name:"\uc678\ubd80 \uac80\uc0c9",fun:function(){},subMenu:[{name:"Naver",
fun:function(a,b){void 0!=window.viewer?window.viewer.link("link","https://search.naver.com/search.naver?where=nexearch&query="+encodeURIComponent(selectedKeyword)+"&sm=top_hty&fbm=1&ie=utf8"):window.open("https://search.naver.com/search.naver?where=nexearch&query="+encodeURIComponent(selectedKeyword)+"&sm=top_hty&fbm=1&ie=utf8");disableHighlight()}},{name:"Daum",fun:function(a,b){void 0!=window.viewer?window.viewer.link("link","http://search.daum.net/search?w=tot&DA=YZR&t__nil_searchbox=btn&sug=&sugo=&sq=&o=&q="+
encodeURIComponent(selectedKeyword)+"&tltm=1"):window.open("http://search.daum.net/search?w=tot&DA=YZR&t__nil_searchbox=btn&sug=&sugo=&sq=&o=&q="+encodeURIComponent(selectedKeyword)+"&tltm=1");disableHighlight()}},{name:"Google",fun:function(a,b){void 0!=window.viewer?window.viewer.link("link","http://www.google.com/search?q="+encodeURIComponent(selectedKeyword)):window.open("http://www.google.com/search?q="+encodeURIComponent(selectedKeyword));disableHighlight()}}]},{className:"CloseHighlight",name:"\ud558\uc774\ub77c\uc774\ud2b8 \uc885\ub8cc",
fun:function(){disableHighlight()}}];isWebview&&window.lampedu&&($("#top_menu").hide(),$("#bottom_menu").hide(),epub_code=window.lampedu.getEpubCode(),epubPath=window.lampedu.getEpubPath(),console.log("Epub Path : "+epubPath));function isMobile(){return/Android|webOS|iPhone|iPad|BlackBerry|Windows Phone|Opera Mini|IEMobile|Mobile/i.test(navigator.userAgent)?!0:!1}function isIpad(){return/iPhone|iPad/i.test(navigator.userAgent)?!0:!1}
function copyToClipboard(a){var b="INPUT"===a.tagName||"TEXTAREA"===a.tagName;if(b){e=a;var c=a.selectionStart;var d=a.selectionEnd}else{e=document.getElementById("_hiddenCopyText_");if(!e){var e=document.createElement("textarea");e.style.position="absolute";e.style.left="-9999px";e.style.top="0";e.id="_hiddenCopyText_";document.body.appendChild(e)}e.textContent=a.textContent}var f=document.activeElement;e.focus();e.setSelectionRange(0,e.value.length);try{var g=document.execCommand("copy")}catch(h){g=
!1}f&&"function"===typeof f.focus&&f.focus();b?a.setSelectionRange(c,d):e.textContent="";return g}function movePrev(a){a?0<=currentOnePageIdx-1&&($("#frame_onepage").attr("src",loadSvg?pages[currentOnePageIdx-1].replace(".xhtml","_s.xhtml"):pages[currentOnePageIdx-1]),--currentOnePageIdx,resizeOnePage(),rangeSlider.noUiSlider.set(currentOnePageIdx)):0<=currentPageIdx-2&&rangeSlider.noUiSlider.set(currentPageIdx-2)}
function moveNext(a){a?currentOnePageIdx+1<=pages.length-1&&(currentOnePageIdx+=1,resizeOnePage(),rangeSlider.noUiSlider.set(currentOnePageIdx)):currentPageIdx+2<=pages.length-1&&rangeSlider.noUiSlider.set(currentPageIdx+2)}function disableHighlight(){clearHighlight();$("#btn_highlight").removeClass("active");$("#canvas_highlight").css("pointer-events","none")}function locationPage(a){sideMenu.closeAll();requestedPage=a;rangeSlider.noUiSlider.set(requestedPage)}
function goPage(){void 0!=window.viewer&&window.viewer.stopWorker();var a=requestedPage;console.log("Go page to "+requestedPage);"oneside"==viewBox.mode&&$("#frame_onepage").attr("src",loadSvg?pages[requestedPage].replace(".xhtml","_s.xhtml"):pages[requestedPage]);a=a%2?a-1:a;$(".page_frame_left").attr("src",loadSvg?pages[a].replace(".xhtml","_b.xhtml"):pages[a]);"HP"==creator?a+1<=pages.length-1?$(".page_frame_right").attr("src",loadSvg?pages[a+1].replace(".xhtml","_b.xhtml"):pages[a+1]):$(".page_frame_right").attr("src",
blankPage):$(".page_frame_right").attr("src",loadSvg?pages[a+1].replace(".xhtml","_b.xhtml"):pages[a+1]);currentPageIdx=a;loadPageInfo(currentPageIdx);loadBookmark();if(void 0!==window.lampedu)window.lampedu.onPageChange(currentPageIdx);else void 0!=window.viewer?(loadBG&&window.viewer.changeBG(a),window.viewer.onPageMoved(currentPageIdx)):console.log("undefined window.lampedu. "+currentPageIdx);isLoadedPageFlip&&($(".flipbook").show(),$(".flipbook").turn("page",currentPageIdx+1))}
function goPageWithUrl(a){sideMenu.closeAll();for(var b=0;b<pages.length;b++)0<=pages[b].indexOf(a)&&rangeSlider.noUiSlider.set(b)}function getCurPageIdx(){return currentPageIdx}function linkAction(a){setTimeout(function(){window.open(a,"_blank")},0)}function link(a,b){void 0!==windows.viewer&&windows.viewer.link(a,b)}function goPageWithIdx(a){rangeSlider.noUiSlider.set(a)}function setOpenToc(){sideMenu.toggle(SIDEMENU_TOC)}function setOpenThumb(){sideMenu.toggle(SIDEMENU_THUMB)}
function setOpenSearch(a){sideMenu.toggle(SIDEMENU_SEARCH)}function numbering(a){return 10>a?"00"+a:100>a?"0"+a:a}function loadEpub(){null==epubDB.base?(console.log("#Load Epub : "+epubPath+"/pp_db/base.json"),$.getJSON(epubPath+"/pp_db/base.json",{}).done(function(a){epubDB.base=a;epubInfo=a.info;epubToc=a.toc;initEpub()}).fail(function(a,b,c){console.log("Request Failed: "+(b+", "+c));$(".cover_loader").hide()})):initEpub()}
function initEpub(){epubInfo.startpage=0;epubInfo.menu_toc="Y";epubInfo.menu_thumb="Y";epubInfo.menu_single="Y";epubInfo.menu_double="Y";epubInfo.menu_highlight="Y";epubInfo.menu_draw="Y";epubInfo.menu_bookmark="Y";epubInfo.menu_help="Y";epubInfo.menu_search="Y";"Y"==epubInfo.menu_toc&&$(".topBtnList").css("display","inline-block");"Y"==epubInfo.menu_thumb&&$(".topBtnThumbnail").css("display","inline-block");"Y"==epubInfo.menu_single&&$(".topBtnOne").css("display","inline-block");"Y"==epubInfo.menu_double&&
$(".topBtnTwo").css("display","inline-block");"Y"==epubInfo.menu_highlight&&$(".topBtnHighlight").css("display","inline-block");"Y"==epubInfo.menu_draw&&$(".drawing").css("display","inline-block");"Y"==epubInfo.menu_bookmark&&$(".topBtnBookmark").css("display","inline-block");"Y"==epubInfo.menu_help&&$(".help").css("display","inline-block");console.log("Epub Info #########################");console.log(epubInfo);console.log("Epub Toc #########################");console.log(epubToc);pages=[];for(var a=
0;a<epubDB.base.pages.length;a++)"HP"==creator?0<=epubDB.base.pages[a].url.indexOf("blank")?pages.push(epubDB.base.pages[a].url):pages.push(epubPath+"/"+epubDB.base.pages[a].url):pages.push(epubPath+"/"+epubDB.base.pages[a].url);console.log("Epub Pages #########################");console.log(pages);for(a=0;a<epubToc.length;a++)if(console.log("toc : "+epubToc[a].title),"pd"!=preview&&0<epubInfo.limitpage)for(var b=0;b<epubDB.base.pages.length;b++){if(0<=epubDB.base.pages[b].url.indexOf(epubToc[a].url)){$("#menu_contents").append("<li onClick=\"goPageWithUrl('"+
epubToc[a].url+"')\"><p>"+epubToc[a].title+'</p><span class="no">'+epubToc[a].page_idx+"</span></li>");break}}else $("#menu_contents").append("<li onClick=\"goPageWithUrl('"+epubToc[a].url+"')\"><p>"+epubToc[a].title+'</p><span class="no">'+epubToc[a].page_idx+"</span></li>");initPageSlider();loadPageInfo(0);loadBookmark();resizeViewer();$(".cover_loader").hide();setTimeout(function(){void 0!=window.viewer&&window.viewer.startCache()},2E3)}
function loadPageFlipAni(){for(var a,b=0;b<Number(epubInfo.totalpage);b++)a=$("<div style='background-image:url("+epubPath+"/pp_print/"+pageFormat(b+1)+"."+imgFormat+")'></div>"),$(".flipbook").append(a);$(".flipbook").turn({acceleration:!0,elevation:50,gradients:!0,display:"double",page:1,autoCenter:!1,duration:700,when:{turned:function(a,b,e){$(".flipbook").fadeOut(0);isLoadedPageFlip=!0},end:function(a,b,e){$(".flipbook").fadeOut(500);isLoadedPageFlip=!0}}});setTimeout(function(){$(".cover_loader").hide()},
2E3)}function clearHighlight(){null!=hl_context&&hl_context.clearRect(0,0,hl_canvas.width,hl_canvas.height)}
function loadDrawData(){void 0===window.viewer&&(drawingCanvas.clear(),null!=localStorage.getItem("drawing_"+epub_code)&&(drawingData=JSON.parse(localStorage.getItem("drawing_"+epub_code)),console.log("Drawing Data #########################"),null!=drawingData[currentPageIdx]&&console.log(drawingData[currentPageIdx]),console.log("#########################"),null!=localStorage.getItem("drawing_"+epub_code)&&drawingCanvas.loadFromJSON(drawingData[currentPageIdx],function(){drawingCanvas.renderAll();
disableSelectObject()})))}function loadPageInfo(a){clearHighlight();null==epubDB.page?$.getJSON(epubPath+"/pp_db/page.json",{}).done(function(b){epubDB.page=b;initPageInfo(a)}).fail(function(a,c,d){console.log("Request Failed: "+(c+", "+d))}):initPageInfo(a)}
function initPageInfo(a){"HP"==creator?1==epubDB.page.length||0==a?(pageInfo=[],pageInfo.push({contents:"",matrix:[],thumbnail:"",url:""}),pageInfo.push(epubDB.page[0])):(pageInfo=[],pageInfo.push(epubDB.page[a-1]),pageInfo.push(epubDB.page[a])):(pageInfo=[],pageInfo.push(epubDB.page[a]),pageInfo.push(epubDB.page[a+1]));console.log("Page Info #########################");console.log("/epub/page/"+epub_code+"/"+a+"/");console.log(pageInfo);console.log("#########################");0<pageInfo[0].svg_w?
(svgViewBox.w=pageInfo[0].svg_w,svgViewBox.h=pageInfo[0].svg_h):(svgViewBox.w=pageInfo[1].svg_w,svgViewBox.h=pageInfo[1].svg_h);console.log("SVG W : "+svgViewBox.w+", SVG H : "+svgViewBox.h);loadBG||("HP"==creator?($("#naviBackImageLeft").attr("src",0==a&&""==pageInfo[0].thumbnail?"./resources/img/common/empty.jpg":epubPath+pageInfo[0].thumbnail),$("#naviBackImageRight").attr("src",void 0==pageInfo[1]?"./resources/img/common/empty.jpg":epubPath+pageInfo[1].thumbnail),$("#page_selector_left").attr("src",
0==a&&""==pageInfo[0].thumbnail?"./resources/img/common/empty.jpg":epubPath+pageInfo[0].thumbnail)):($("#naviBackImageLeft").attr("src",epubPath+pageInfo[0].thumbnail),$("#naviBackImageRight").attr("src",void 0==pageInfo[1]?"./resources/img/common/empty.jpg":epubPath+pageInfo[1].thumbnail),$("#page_selector_left").attr("src",epubPath+pageInfo[0].thumbnail)),$("#page_selector_right").attr("src",void 0==pageInfo[1]?"./resources/img/common/empty.jpg":epubPath+pageInfo[1].thumbnail));resizeViewer()}
function loadBookmark(){if(void 0===window.viewer){bookmarkData=null!=localStorage.getItem("bookmark_"+epub_code)?JSON.parse(localStorage.getItem("bookmark_"+epub_code)):[];bookmarkData.sort(function(a,c){return parseFloat(a.pageidx)-parseFloat(c.pageidx)});$("#menu_bookmarks").empty();$("#bookmark_left").hide();$("#bookmark_right").hide();for(var a=0;a<bookmarkData.length;a++)null!=bookmarkData[a]&&(currentPageIdx==parseInt(bookmarkData[a].pageidx)&&$("#bookmark_left").show(),currentPageIdx+1==parseInt(bookmarkData[a].pageidx)&&
$("#bookmark_right").show(),$("#menu_bookmarks").append("<li><p onClick=\"goPageWithIdx('"+bookmarkData[a].pageidx+"')\">"+bookmarkData[a].title+'</p><button type="button" class="btn btn-warning btn-sm" style="position:absolute;top:15px;right:20px;" onClick="removeBookmark('+bookmarkData[a].pageidx+')"><span class="glyphicon glyphicon-minus"></span></button></li>'))}}
function addBookmark(a){a=currentPageIdx+a;for(var b=!1,c=0;c<bookmarkData.length;c++)if(null!=bookmarkData[c]&&bookmarkData[c].pageidx==a){b=!0;break}b||(bookmarkData.push({pageidx:a,title:"page"+(a-parseInt(epubInfo.startpage))}),localStorage.setItem("bookmark_"+epub_code,JSON.stringify(bookmarkData)),loadBookmark())}
function removeBookmark(a){for(var b=-1,c=0;c<bookmarkData.length;c++)if(null!=bookmarkData[c]&&bookmarkData[c].pageidx==a){b=c;break}0<=b&&(bookmarkData.splice(b,1),localStorage.setItem("bookmark_"+epub_code,JSON.stringify(bookmarkData)),loadBookmark())}function goSearchPage(a){setViewMode(2);rangeSlider.noUiSlider.set(parseInt(a)+parseInt(epubInfo.startpage));setTimeout(function(){drawHighlight()},1800)}
function searchKeyword(a){$(".cover_loader").show();result_data=[];for(var b,c=0;c<epubDB.page.length;c++)0<=epubDB.page[c].contents.indexOf(a)&&(b=100<epubDB.page[c].contents.length?epubDB.page[c].contents.substr(0,100)+"...":epubDB.page[c].contents,result_data.push({page_idx:c+1,thumbnail:epubPath+epubDB.page[c].thumbnail,contents:b.trim(),url:epubDB.page[c].url,go_page_idx:c+1}));if(resultType===TYPE_SLIDE){for(c=0;c<result_data.length;c++)$("#contents_search").append("<li onClick='goSearchPage(\""+
result_data[c].go_page_idx+"\")'><p>"+result_data[c].contents+"</p><span class='no'>"+result_data[c].page_idx+"</span></li>");$(".cover_loader").hide();sideMenu.open(SIDEMENU_SEARCH)}else $("#jsGrid").jsGrid({width:"100%",height:"400px",inserting:!1,editing:!1,sorting:!1,paging:!0,data:result_data,rowClick:function(){},fields:[{name:"page_idx",type:"number",title:"Page",width:100,validate:"required",sorting:!1,align:"center"},{name:"thumbnail",itemTemplate:function(a,b){return $("<img>").attr("src",
a).css({height:110,width:80}).on("click",function(){})},insertTemplate:function(){return this.insertControl=$("<input>").prop("type","file")},insertValue:function(){return this.insertControl[0].files[0]},title:"Thumbnail",align:"center",width:100,sorting:!1},{name:"contents",type:"text",title:"Contents",width:274,sorting:!1},{name:"go_page_idx",title:"Go",width:90,align:"center",itemTemplate:function(a,b){return $("<button type='button' class='btn btn-primary'>").text("Go").on("click",function(){console.log(a);
$("#modalSearchResults").modal("hide");setViewMode(2);rangeSlider.noUiSlider.set(parseInt(a)+parseInt(epubInfo.startpage));setTimeout(function(){drawHighlight()},1800);return!1})}}]}),$(".cover_loader").hide(),$("#modalSearchResults").modal()}
function resizeViewer(){var a=$(window).width(),b=$(window).height(),c=$(window).width()/2,d=c/epubInfo.width,e=b/epubInfo.height;viewPort.w=a;viewPort.h=b;viewBox.scale=Math.min(d,e);(d=100<viewBox.zoom&&"oneside"!=viewBox.mode)?(viewBox.scale*=parseInt(viewBox.zoom)/100,$("#btn_move_left").show(),$("#btn_move_right").show(),$("#btn_move_up").show(),$("#btn_move_down").show()):($("#btn_move_left").hide(),$("#btn_move_right").hide(),$("#btn_move_up").hide(),$("#btn_move_down").hide());var f=epubInfo.width*
viewBox.scale;e=epubInfo.height*viewBox.scale;viewBox.w=f;viewBox.h=e;svgViewBox.scale=f/svgViewBox.w;pageWidth=f;d?(a<2*f?($("#btn_move_left").show(),$("#btn_move_right").show()):($("#btn_move_left").hide(),$("#btn_move_right").hide()),b<e?($("#btn_move_up").show(),$("#btn_move_down").show()):($("#btn_move_up").hide(),$("#btn_move_down").hide()),$("#naviViewport").show(),$("#btn_zoom").hide()):($("#btn_move_left").hide(),$("#btn_move_right").hide(),$("#btn_move_up").hide(),$("#btn_move_down").hide(),
$("#naviViewport").hide(),$(".top_menu .zoom").removeClass("active"));$("#cover_view_control").width(2*f);$("#cover_view_control").height(e);isLoadedPageFlip&&(console.log("Page Height : "+e),$(".flipbook").turn("size",2*f,e));$("#cover_leftpage").width(f).height(e);$("#cover_rightpage").width(f).height(e);$(".page_frame_left").width(epubInfo.width);$(".page_frame_right").width(epubInfo.width);$(".page_frame_left").height(epubInfo.height);$(".page_frame_right").height(epubInfo.height);$(".btn_page_move").show();
$(".btn_page_move").css("top",b/2-$(".btn_page_move").height()/2);d=0;e<b&&(d=(b-e)/2);c-=epubInfo.width*viewBox.scale;$("#cover_view_control").offset({left:c,top:d});e=eval(2*epubInfo.width*viewBox.scale);f=eval(epubInfo.height*viewBox.scale);viewPort.vw=e;viewPort.vh=f;a=parseFloat($("#naviHandleArea").width())*(100==viewBox.zoom||e<a?1:a/e);b=parseFloat($("#naviHandleArea").height())*(100==viewBox.zoom||f<b?1:b/f);$("#naviHandle").width(a);$("#naviHandle").height(b);$("#cover_bookmark").width(e);
$("#cover_bookmark").height(f);$("#cover_bookmark").offset({top:d,left:c});$("#canvas_highlight").width(e);$("#canvas_highlight").height(f);$("#canvas_highlight").offset({top:d,left:c});$("#touchscroll").width(e);$("#touchscroll").height(f);$("#touchscroll").offset({top:d,left:c});hl_canvas.width=e;hl_canvas.height=f;pageZoom(viewBox.scale);null!=drawingCanvas&&($("#cover_drawing").css("top",d),$("#cover_drawing").css("left",c),$("#cover_drawing").width(e),$("#cover_drawing").height(f),$("#drawingCanvas").width(e),
$("#drawingCanvas").height(f),drawingCanvas.setWidth(e),drawingCanvas.setHeight(f),drawingCanvas.setZoom(viewBox.scale),drawingCanvas.renderAll());$("#tool_drawing").css("top",350);$("#tool_drawing").css("left",200);moveNaviHandle();"oneside"==viewBox.mode?(resizeOnePage(),$("#btn_zoom").hide()):$("#btn_zoom").show()}
function moveNaviHandle(){if(100==viewBox.zoom)$("#naviHandle").css("top",0),$("#naviHandle").css("left",0);else{var a=$("#cover_view_control").offset().top,b=$("#cover_view_control").offset().left;b=viewPort.vw<viewPort.w?0:-b*(parseFloat($("#naviHandleArea").width())/viewPort.vw);a=viewPort.vh<viewPort.h?0:-a*(parseFloat($("#naviHandleArea").height())/viewPort.vh);$("#naviHandle").css("top",a);$("#naviHandle").css("left",b)}}
function moveContentsViewer(){var a=$(window).width(),b=$(window).height(),c=parseFloat($("#naviHandle").css("top")),d=parseFloat($("#naviHandle").css("left")),e=parseFloat($("#cover_view_control").width()),f=parseFloat($("#cover_view_control").height());d=-(d*(e/parseFloat($("#naviHandleArea").width())));c=-(c*(f/parseFloat($("#naviHandleArea").height())));e<a&&(d=(a-e)/2);f<b&&(c=(b-f)/2);$("#cover_view_control").offset({top:c,left:d});$("#canvas_highlight").offset({top:c,left:d});$("#cover_drawing").offset({top:c,
left:d})}
function moveContentsByArrow(a){var b=$(window).width(),c=$(window).height(),d=viewBox.moving_step*(parseInt(viewBox.zoom)/100);switch(a){case "left":a=parseFloat($("#cover_view_control").css("left"))+d;0<a&&(a=0);$("#cover_view_control").offset({left:a});$("#canvas_highlight").css("left",a);$("#cover_drawing").css("left",a);break;case "right":a=parseFloat($("#cover_view_control").css("left"))-d;d=parseFloat($("#cover_view_control").css("left"))-d;b-=parseFloat($("#cover_view_control").width());d<
b&&(a=b);$("#cover_view_control").offset({left:a});$("#canvas_highlight").css("left",a);$("#cover_drawing").css("left",a);break;case "up":a=parseFloat($("#cover_view_control").css("top"))+d;0<a&&(a=0);$("#cover_view_control").offset({top:a});$("#canvas_highlight").css("top",a);$("#cover_drawing").css("top",a);break;case "down":a=parseFloat($("#cover_view_control").css("top"))-d,d=parseFloat($("#cover_view_control").css("top"))-d,b=c-parseFloat($("#cover_view_control").height()),d<b&&(a=b),$("#cover_view_control").offset({top:a}),
$("#canvas_highlight").css("top",a),$("#cover_drawing").css("top",a)}moveNaviHandle()}
function resizeOnePage(){var a=$(window).width(),b=$(window).height(),c=a/epubInfo.width;a<b&&isIpad()&&(c=b/epubInfo.height);$("#cover_onepage").width(a);$("#cover_onepage").height(b);$("#frame_onepage").width(epubInfo.width);$("#frame_onepage").height(epubInfo.height);$(".scroll-wrapper").width(a).height(b);detectIE()?$("#frame_onepage").css("zoom",c):($("#frame_onepage").css("zoom",1),$("#frame_onepage").css("-moz-transform","scale("+c+")"),$("#frame_onepage").css("-moz-transform-origin","0 0"),
$("#frame_onepage").css("-o-transform","scale("+c+")"),$("#frame_onepage").css("-o-transform-origin","0 0"),$("#frame_onepage").css("-webkit-transform","scale("+c+")"),$("#frame_onepage").css("-webkit-transform-origin","0 0"));$(".frame_cover").width(epubInfo.width*c).height(epubInfo.height*c);$("#drawingCanvasOnepage").width(2*epubInfo.width*c);$("#drawingCanvasOnepage").height(epubInfo.height*c);epubInfo.height*c<b?(b=(b-epubInfo.height*c)/2,$(".frame_cover").css("top",b)):(b=0,$(".frame_cover").css("top",
0));epubInfo.width*c<a?(b=(a-epubInfo.width*c)/2,$(".frame_cover").css("left",b)):(b=0,$(".frame_cover").css("left",0));$("#drawingCanvasOnepage").parent().css("top",b);$("#drawingCanvasOnepage").parent().css("left",0);$("#drawingCanvasOnepage").parent().css("position","absolute");drawingCanvasOnepage.setWidth(2*epubInfo.width*c);drawingCanvasOnepage.setHeight(epubInfo.height*c);drawingCanvasOnepage.setZoom(c);drawingCanvasOnepage.renderAll();void 0===window.viewer&&null!=localStorage.getItem("drawing_"+
epub_code)&&(drawingData=JSON.parse(localStorage.getItem("drawing_"+epub_code)),null!=localStorage.getItem("drawing_"+epub_code)&&drawingCanvasOnepage.loadFromJSON(drawingData[currentOnePageIdx%2?currentOnePageIdx-1:currentOnePageIdx],function(){drawingCanvasOnepage.renderAll()}));drawingCanvasOnepage.renderAll();disableSelectObjectOnepage();a=0==currentOnePageIdx%2?0:epubInfo.width*c;$("#drawingCanvasOnepage").css("left",-a)}
function pageZoom(a){detectIE()?($(".page_frame_left").css("zoom",a),$(".page_frame_right").css("zoom",a)):($(".page_frame_left").css("zoom",1),$(".page_frame_right").css("zoom",1),$(".page_frame_left").css("-moz-transform","scale("+a+")"),$(".page_frame_left").css("-moz-transform-origin","0 0"),$(".page_frame_left").css("-o-transform","scale("+a+")"),$(".page_frame_left").css("-o-transform-origin","0 0"),$(".page_frame_left").css("-webkit-transform","scale("+a+")"),$(".page_frame_left").css("-webkit-transform-origin",
"0 0"),$(".page_frame_right").css("-moz-transform","scale("+a+")"),$(".page_frame_right").css("-moz-transform-origin","0 0"),$(".page_frame_right").css("-o-transform","scale("+a+")"),$(".page_frame_right").css("-o-transform-origin","0 0"),$(".page_frame_right").css("-webkit-transform","scale("+a+")"),$(".page_frame_right").css("-webkit-transform-origin","0 0"))}
function loadThumb(){$("#contents_thumbnails").empty();var a=epubDB.base.pages;for(var b,c=0;c<a.length;c++)""==a[c].thumbnail?b="./resources/img/common/empty.jpg":"HP"==creator?b=epubPath+"/pp_thumbnail/"+a[c].thumbnail:(console.log(b),b=epubPath+"/"+a[c].thumbnail),$("#contents_thumbnails").append("<li onclick='locationPage("+(parseInt(a[c].idx)-1)+")' style='background:#FFFFFF;'><span>"+(c-parseInt(epubInfo.startpage))+"</span><img src='"+b+"'></li>");sideMenu.thumb.isLoaded=!0;classie.add(sideMenu.thumb,
"cbp-spmenu-open")}
function initViewer(){hl_canvas=document.getElementById("canvas_highlight");hl_context=hl_canvas.getContext("2d");sideMenu.setMenu(document.getElementById("cbp-spmenu-s1"),SIDEMENU_TOC);sideMenu.setMenu(document.getElementById("cbp-spmenu-s2"),SIDEMENU_THUMB);sideMenu.setMenu(document.getElementById("cbp-spmenu-s3"),SIDEMENU_BOOKMARK);sideMenu.setMenu(document.getElementById("cbp-spmenu-s4"),SIDEMENU_SEARCH);document.getElementById("btn_toc").onclick=function(){sideMenu.toggle(SIDEMENU_TOC)};document.getElementById("btn_bookmark").onclick=
function(){sideMenu.toggle(SIDEMENU_BOOKMARK)};document.getElementById("btn_allpage").onclick=function(){sideMenu.toggle(SIDEMENU_THUMB)}}
function initPageSlider(){rangeSlider=document.getElementById("pageSlider");noUiSlider.create(rangeSlider,{start:[0],step:1,range:{min:[0],max:[Number(epubInfo.totalpage)]},tooltips:!1});rangeSlider.noUiSlider.on("update",function(a,b){console.log("Slider Value : "+parseInt(a));$("#pageLabel").text(parseInt(a)-parseInt(epubInfo.startpage)+1+" Page");null!=pageLocationTask&&(console.log("Clear "+pageLocationTask),clearTimeout(pageLocationTask));requestedPage=parseInt(a);pageLocationTask=setTimeout(goPage,
500)})}function menuToggle(){"0px"==$("#top_menu").css("top")?menuClose():menuOpen()}function menuOpen(){$("#top_menu").animate({top:"0px"});$("#bottom_menu").animate({bottom:"0px"});$(".top_menu_handle").addClass("off");$(".bottom_menu_handle").addClass("off")}function menuClose(){$("#top_menu").animate({top:"-60px"});$("#bottom_menu").animate({bottom:"-60px"});$(".top_menu_handle").removeClass("off");$(".bottom_menu_handle").removeClass("off")}
function openDrawing(){sideMenu.closeAll();$("#tool_drawing").show();"oneside"==viewBox.mode?$("#cover_onepage .canvas-container").css("pointer-events","auto"):$("#cover_drawing").css("pointer-events","auto");void 0!==window.lampedu&&window.lampedu.setDrawingChange(!0)}
function closeDrawing(){$("#tool_drawing").hide();$("#cover_drawing").css("pointer-events","none");$("#cover_onepage .canvas-container").css("pointer-events","none");saveDrawingData();void 0!==window.lampedu&&window.lampedu.setDrawingChange(!1)}function closeNavi(){$(".top_menu .zoom").removeClass("active");$("#touchscroll").css("pointer-events","none");viewBox.zoom=100;resizeViewer()}
function setOnHighlight(a){a?($("#canvas_highlight").css("pointer-events","auto"),$("#btn_highlight").addClass("active")):disableHighlight()}
function setViewMode(a){closeDrawing();sideMenu.closeAll();1==a?(drawingCanvasOnepage.clear(),viewBox.mode="oneside",currentOnePageIdx=currentPageIdx,$("#frame_onepage").prop("src",loadSvg?pages[currentOnePageIdx].replace(".xhtml","_s.xhtml"):pages[currentOnePageIdx]),$("#cover_onepage").show(),$("#cover_drawing").hide()):(drawingCanvas.clear(),viewBox.mode="both",$("#cover_onepage").hide(),$("#cover_drawing").show(),loadDrawData());resizeViewer()}
function initZoom(){console.log(viewBox.zoom);100>=viewBox.zoom?($(".top_menu .zoom").addClass("active"),$("#touchscroll").css("pointer-events","auto"),$("#zoomSliderTxt").text("200%"),viewBox.zoom=200):($(".top_menu .zoom").removeClass("active"),$("#touchscroll").css("pointer-events","none"),$("#zoomSliderTxt").text("100%"),viewBox.zoom=100);resizeViewer()}
function loadPageWithBG(){var a=currentPageIdx;$(".page_frame_left").attr("src",pages[a]);a+1<=pages.length-1?$(".page_frame_right").attr("src",pages[a+1]):$(".page_frame_right").attr("src",blankPage)}var curDown=!1,lastXPos=0,lastYPos=0,curYPos=0,curXPos=0;
$(document).ready(function(){$.ajaxSetup({cache:!0});initViewer();loadEpub();$(window).resize(function(){setTimeout(function(){resizeViewer()},500)});initHighlightCanvas();$("#canvas_highlight").contextMenu(menu,{triggerOn:"none"});$("#drawing-color").spectrum({preferredFormat:"hex3",change:function(a){}});$(".menu_handle").click(function(){menuToggle()});var a=$(window).width(),b=$(window).height(),c=b-121-155;a=a-150-90;$("#naviViewport").draggable().css("top",c+"px").css("left",a+"px");$("#naviHandle").draggable({containment:"#naviHandleArea",
scroll:!1,start:function(){},drag:function(){moveContentsViewer()},stop:function(){}});$("#tool_drawing").draggable();$(".navi_close").click(function(){closeNavi()});$("#leftpage1").attr("src",loadSvg?pages[0].replace(".xhtml","_s.xhtml"):pages[0]);$("#goto_btn").click(function(){locationPage(eval($("#pagenum").val())-1)});$("#pagenum").keyup(function(a){13==a.keyCode&&locationPage(eval($("#pagenum").val()-1))});$("#search_btn").click(function(){keyword=$("#search_key").val();searchKeyword(keyword)});
$("#btn_search").click(function(){keyword=$("#search_keyword").val();searchKeyword(keyword)});$("#search_keyword").keyup(function(a){13==a.keyCode&&(keyword=$("#search_key").val(),searchKeyword(keyword))});$("#search_key").keyup(function(a){13==a.keyCode&&(keyword=$("#search_key").val(),searchKeyword(keyword))});$("#btn_page_prev").click(function(){movePrev("oneside"==viewBox.mode)});$("#btn_page_next").click(function(){moveNext("oneside"==viewBox.mode)});$("#btn_home").click(function(){window.location.reload()});
$("#btn_add_bookmark").click(function(){$(".page_selector").show()});$(".btn_popup_close").click(function(){$(".page_selector").hide()});$("#page_selector_left").click(function(){addBookmark(0);$(".page_selector").hide()});$("#page_selector_right").click(function(){addBookmark(1);$(".page_selector").hide()});$("#btn_zoom").click(function(){initZoom()});$(".zoom_in").click(function(){300<=viewBox.zoom||(viewBox.zoom+=50,$("#zoomSliderTxt").text(viewBox.zoom+"%"),resizeViewer())});$(".zoom_out").click(function(){100>=
viewBox.zoom||(viewBox.zoom-=50,$("#zoomSliderTxt").text(viewBox.zoom+"%"),resizeViewer())});$(".btn_close").click(function(){sideMenu.closeAll()});$("#btn_close_thumbnails").click(function(){sideMenu.close(SIDEMENU_THUMB)});$("#btn_onepage").click(function(){setViewMode(1)});$("#btn_bothpage").click(function(){setViewMode(2)});$("#btn_highlight").click(function(){sideMenu.closeAll();"none"==$("#canvas_highlight").css("pointer-events")?($("#canvas_highlight").css("pointer-events","auto"),$("#btn_highlight").addClass("active")):
disableHighlight()});$("#btn_drawing").click(function(){openDrawing()});$("#btn_help").click(function(){$("#helpIframe").height(b-50).attr("src",epubInfo.link_help);$("#helpModal").modal({show:!0})});$(".expand_tool").click(function(){$(".drawing_contents").is(":hidden")?($("#tool_drawing").height("250"),$(".drawing_contents").show(),$(".expand_tool").removeClass("expanded")):($("#tool_drawing").height("95"),$(".drawing_contents").hide(),$(".expand_tool").addClass("expanded"))});$("#btn_close_drawing").click(function(){closeDrawing()});
$("#btn_move_left").click(function(){moveContentsByArrow("left")});$("#btn_move_right").click(function(){moveContentsByArrow("right")});$("#btn_move_up").click(function(){moveContentsByArrow("up")});$("#btn_move_down").click(function(){moveContentsByArrow("down")});$("#btn_add_image").click(function(){});$("#btn_saveto_image").click(function(){window.open(drawingCanvas.toDataURL("png"))});$("#btn_hide_drawing").click(function(){$("#cover_drawing").is(":visible")?($("#cover_drawing").hide(),$("#btn_hide_drawing").addClass("on")):
($("#cover_drawing").show(),$("#btn_hide_drawing").removeClass("on"))});$("#touchscroll").bind("touchmove",function(a){touchMove(a);a.preventDefault()});$("#touchscroll").bind("touchstart",function(a){touchDown(a);a.preventDefault()});$("#touchscroll").bind("touchend",function(a){curDown=!1;a.preventDefault()});$("#touchscroll").bind("touchleave",function(a){curDown=!1;a.preventDefault()});$("#touchscroll").mousemove(function(a){touchMove(a)});$("#touchscroll").mousedown(function(a){touchDown(a)});
$("#touchscroll").mouseup(function(){console.log("up");curDown=!1});$("#touchscroll").mouseleave(function(){curDown=!1});$(".movehand").click(function(){$(".movehand").hasClass("active")?($(".movehand").removeClass("active"),$("#touchscroll").css("pointer-events","none")):($(".movehand").addClass("active"),$("#touchscroll").css("pointer-events","auto"))})});var fX=0,fY=0;
function touchMove(a){if(1==curDown&&100<viewBox.zoom){var b=$(window).width(),c=$(window).height();console.log(a);var d=isMobile()?curXPos-a.touches[0].clientX:curXPos-a.clientX;console.log(d+" "+a.clientX);d=fX-d;0<d&&(d=0);var e=b-parseFloat($("#cover_view_control").width());d<e&&(d=e);b=d;d=isMobile()?curYPos-a.touches[0].clientY:curYPos-a.clientY;d=fY-d;0<d&&(d=0);e=c-parseFloat($("#cover_view_control").height());d<e&&(d=e);a=d;$("#cover_view_control").offset({left:b,top:a});$("#canvas_highlight").css("left",
b).css("top",a);$("#cover_drawing").css("left",b).css("top",a);moveNaviHandle()}}function touchDown(a){fX=parseFloat($("#cover_view_control").css("left"));fY=parseFloat($("#cover_view_control").css("top"));console.log("down");curDown=!0;isMobile()?(curXPos=a.touches[0].clientX,curYPos=a.touches[0].clientY):(curXPos=a.clientX,curYPos=a.clientY);lastXPos=curXPos;lastYPos=curYPos};
